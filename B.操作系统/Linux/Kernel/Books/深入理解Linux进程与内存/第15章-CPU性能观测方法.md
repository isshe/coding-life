# 第十五章 CPU 性能观测方法

## 问题

- 常见方法/指标？
- 如何判断上下文切换是否过多？
- 调度器延迟多少合适？

## 解答

### 常见方法/指标？

- CPU 利用率，相关命令：top、mpstat、iostat、ps、pidstat、/proc/stat、/proc/PID/stat
- 热点火焰图：分析热点调用，进行针对性优化
- 系统调用：
  - 统计系统调用：`strace -c -p PID`
- 调度器运行情况观测
  - 负载：uptime、w、top、/proc/loadavg
  - 上下文切换次数：`vmstat 1`、`sar -w 1`、`pidstat -w 3`、`cat /proc/PID/status`、`perf stat -p PID sleep 5`
  - 任务迁移次数
  - 调度器延迟
- 虚拟内存开销
- 网络协议栈开销
- 硬件运行指令效率：CPI、IPC。TODO
- 缓存命中率

TODO 个人实践：将这些分析方法，整理成一个一键脚本！

### 如何判断上下文切换是否过多？

- 评估单核切换次数：将每秒发生的总上下文切换次数除以当前系统的核心数。单核每秒低于 100 次（10ms 一次），则不高；300 次，则需要关注；500 次，过多了。
- 评估进程切换次数：以没有开启多线程的进程为例，只会并行占用一个 CPU 核心。如果是多线程进程，则需要再按线程数平均。统计口径同上。
- 区分主动切换和被动切换：切换过多后，进一步判断主被动。主动过多可能给是因为采用同步阻塞的方式处理 IO；被动过多表示 CPU 争抢严重，CPU 资源不足。

### 调度器延迟多少合适？

通常 1ms 以内算正常，大于 1ms 可能 CPU 有瓶颈。
