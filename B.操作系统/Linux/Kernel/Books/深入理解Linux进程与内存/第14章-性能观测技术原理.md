# 第十四章 性能观测技术原理

## 问题

- 事件类型
- 静态追踪开启方式
- 静态追踪的原理
- 动态追踪开启方式
- 动态追踪的原理
- perf 命令使用

## 解答

### 事件类型

- 硬件事件：Hardware Event，查看事件列表的命令：`perf list hw cache`。事件示例：CPU 执行指令数、时钟周期数、L1/TLB 缓存相关事件等。
- 软件事件：Software Event，查看事件列表的命令：`perf list sw`。事件示例：进程上下文切换、缺页中断等
- 静态追踪点事件：Tracepoint Event，查看事件列表的命令：`perf list tracepoint`。

### 静态追踪开启方式

TODO p448

### 静态追踪的原理

TODO p448

（其实就是静态注册一些 hook）

### 动态追踪开启方式

```bash
cd /sys/kernel/debug/tracing

# 创建跟踪点
echo 'p:test schedule' >> kprobe_events

# 开启
echo '1' > events/kprobes/test/enable

# 查看跟踪输出
cat /sys/kernel/debug/tracing/trace_pipe

# 关闭
echo '0' > events/kprobes/test/enable
```

创建名为 test 的跟踪点，同时会生成对应的目录，位于 `/sys/kernel/debug/tracing/events/kprobes/test`。
还可以通过 perf 进行使用：

```bash
$ perf probe --list | grep test
  kprobes:test         (on schedule@kernel/sched/core.c)

# 录制
perf record -e kprobes:test -a -g sleep 1

# 分析录制内容
perf script
```

### 动态追踪的原理

动态追踪的基本原理是：用 INT3 指令替换（替换通过 register_kprobe 函数进行）掉原本要追踪的函数的地址，进入特定的逻辑，处理完以后，再处理原来的函数。

TODO: INT3?
INT3：INT3_INSN_OPCODE，在 Linux 5.5 版本之前，是 BREAKPOINT_INSTRUCTION 指令。

TODO: 替换以后，如果处理逻辑出错了，地址被修改了，怎么保证系统继续正常运行的呢？

TODO: kprobe 都需要编译成 ko？

所以 kprobe 还是有让系统宕机的风险？！

### perf 命令的使用方法

详见：[perf 命令](../../../../Linux/Commands/perf.md)。
