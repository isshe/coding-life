# 第 2 章 内存硬件原理

## 问题

- 内存的内部物理结构是什么样的？
- 怎么理解内存的主频，它代表内存一秒能工作的次数吗？
- 内存的 CL、tRCD、tRP 这几个参数的含义是什么？
- 内存存在随机 IO 比顺序 IO 访问要慢的情况吗
- 如何查看内存核心频率等信息？
- 什么是内存 Bank Group？
- 什么是核心频率？什么是时钟频率？什么是数据频率？
- ECC 内存是什么？ECC 内存的原理是什么？
- ECC 内存的 8 个校验位的位置是固定的吗？如果是，通常是在什么位置？为什么？
- 什么是 Chip 什么是 rank？
- 什么是顺序 IO、什么是随机 IO？

## 查看内存信息

```bash
cat /proc/meminfo

dmidecode | grep -A16 'Memory Device'
```

## 内存频率

核心频率（Core Frequency）：内存电路的物理震荡频率（如 DDR4-2132 的 133MHz），是内存一下工作的基石

IO 频率（Interface Frequency）：内存与外部控制器（如 CPU）通信时的接口时钟频率

等效传输频率（Effective/Transfer Frequency）：考虑双倍数据速率（DDR）后的有效数据传输率，单位为 MT/s（Million Transfers per second）。等效传输频率 = IO 频率 × 2。

内存真正的工作频率是核心频率，时钟频率和数据频率都是核心频率的基础上，通过技术手段放大出来的，内存越新，放大倍数越大。

| **内存类型** | **预取** | **核心频率** | **IO 频率** | **等效传输频率** | **示例型号**       |
|--------------|----------|--------------|------------|------------------|--------------------|
| DDR          | 2n       | 100MHz       | 100MHz     | 200MT/s          | DDR-200            |
| DDR2         | 4n       | 100MHz       | 200MHz     | 400MT/s          | DDR2-800（200MHz×4）|
| DDR3         | 8n       | 100MHz       | 400MHz     | 800MT/s          | DDR3-1600（200MHz×8）|
| DDR4         | 8n       | 200MHz       | 1600MHz    | 3200MT/s         | DDR4-3200          |

## DIMM 是什么？DIMM 分类？

DIMM：Dual In-Line Memory Module，双列直插式内存模块。

- UDIMM：无缓冲双列直插式内存模块
- SO-DIMM：小型双列直插式内存模块，笔记本内存。
- RDIMM：带寄存器双列直插式内存模块，引入寄存器时钟驱动芯片。
- LRDIMM：低负载双列直插式内存模块，引入寄存器时钟驱动芯片 + 数据缓冲器。

## 内存硬件的内部结构

> 可参考视频：https://www.bilibili.com/video/BV1Htr8YhELV/?spm_id_from=333.337.search-card.all.click&vd_source=185d548ce5c7f87febeb849f042bd47c

概念关系图：

```
+---------------------+
|       Rank 0        |  (由多个 Chip 组成)
| +-----------------+ |
| |      Chip 0     | | → 8-bit 位宽
| |  +------------+ | |
| |  |  Bank 0~7  | | |
| |  +------------+ | |
| +-----------------+ |
|         ...         |
| +-----------------+ |
| |      Chip 7     | |
| +-----------------+ |
+---------------------+


字线--------+------------------------------+
      +----|---------------+         +----|---------------+
    +-|-[ 晶体管 ] -- [电容] |       +-|-[ 晶体管 ] -- [电容]|
    | |    （存储单元）      |       | |    （存储单元）      |
    | +--------------------+       | +--------------------+
    |                              |
   位线                            位线
```

- Cell：存储单元，由一个晶体管和一个电容组成，电容存 0、1。晶体管控制访问。
- Bank：由存储单元组成的二维矩阵；Bank 的宽度（列数）在物理上通常远大于总线位宽（例如 1024）。
  - 这里的列有点疑问，似乎是对实际的列加了一层抽象，书中 Bank 计算是 `行 x 列 x Chip 位宽`，物理列实际应该是 `列 x Chip 位宽`？
  - 每次操作具体的 Cell（1 bit）时，通过 Mask 来进行？
- Chip：内存颗粒，由一层一层 Bank 组成。内存条上每个内存颗粒就是 1 个 Chip
- Rank：多个 Chip 组成一个 Rank，每个 Rank 一次可以并发读写 64 bit 或 72 bit（ECC 内存）。
  - DDR3:8 Banks
  - DDR4:16 Banks（分为 4 个 Bank Group，每组 4 个 Bank）
  - DDR5:32 Banks（8 个 Bank Group，每组 4 个 Bank）
- 内存条上的 2R x 8 标识表示：内存有 2 个 Rank，每个 Chip 位宽是 8 bit。每个 Rank 有 64 / 8 = 8 个颗粒（chip），2 个 Rank 就 16 个颗粒（chip）。
  - 对于位宽 4 bit 的颗粒，16 个颗粒组成一个 Rank
  - 对于位宽 8 bit 的颗粒，8 个颗粒组成一个 Rank
  - 对于位宽 16 bit 的颗粒，4 个颗粒组成一个 Rank
- 位线（bitline）：与存储单元直接连接，用于读书写入电容数据。
- 字线（wordline）：控制存储单元晶体管，由于控制访问哪些
- Burst I/O：预读，也就是给 1 个地址，读 1 批数据，例如 64 bit，假设分给 8 个 chip，那么每个 Chip 8 bit，则 Chip 总线为 8 bit。
- 总线位宽（1 Channel）：等于 1 Rank 位宽，等于 Chip 位宽 x Chip 数量。通常是 64 bit。
- Burst Length：每个 Chip 进行读取次数或列数（`行 x 列 x Chip 位宽` 中的列）。
  - DDR1/DDR2：BL = 4 或 8
  - DDR3/DDR4：默认 BL = 8（支持 Burst Chop = 4）
  - GDDR6：通常 BL = 16 或 32

## 时序参数

| 参数  | 全称                  | 作用周期           | 典型值（DDR4） |
|-------|-----------------------|-------------------|--------------|
| CL    | CAS Latency           | 列地址选通延迟     | 16-22 周期     |
| tRCD  | RAS to CAS Delay      | 行到列转换延迟     | 16-18ns      |
| tRP   | Row Precharge Time    | 行预充电时间       | 16-18ns      |
| tRAS  | Active to Precharge   | 行激活总时间       | 36-38ns      |

时序计算公式：实际延迟 (ns) = 时序值 × (2000/频率)
例：DDR4-3200 CL22 延迟 = 22×(2000/3200)=13.75ns

## 内存 IO 过程

读取：行激活（tRCD）→ 列访问（tCAS）→ 数据传输 → 预充电（tRP）
写入：行激活（tRCD）→ 写入（tCWL）→ 数据传输 → 写回（tWR）→ 预充电（tRP）

为了方便理解，通常把`预充电（tRP）`放在前面。因为这些操作是一直循环的，因此放在前后区别不大。

## 存储性能测试

> 测试代码见：https://github.com/yanfeizhang/deep_linux_process_memory_tests

性能指标：随机读写，顺序读写。

### 测试方法

每次申请一块不同大小的内存，通过不同的步长来访问，计算每次访问需要的时间。代码中是申请一块 64 MB 的内存，然后重复使用。
访问的数组大小分别是：2KB、4KB、... 32MB、64MB。
访问的步长分别是：1、2、... 32、64。

顺序读写：按照步长进行访问；持续突发传输（Burst Transfer），速度更快
随机读写：随机步长进行访问；频繁的预充电和行激活，速度慢。

## ECC 内存原理

### 奇偶校验

**原理**：

奇偶校验是一种基本的错误检测机制，通过在数据块中添加一个额外的校验位来检查数据的奇偶性。
- 偶校验：如果数据中的 1 的个数为偶数，则校验位设为 0；否则设为 1。
- 奇校验：如果数据中的 1 的个数为奇数，则校验位设为 0；否则设为 1。

当数据被读取时，通过重新计算 1 的个数来验证数据是否发生错误。

**优点**：

- 实现简单，计算开销低，仅需 1 位额外空间

**缺点**：

- 只能检测 1 bit 反转，无法纠正错误。
- 无法检测 2 bit 及以上的错误（若两个比特同时翻转，奇偶性保持不变）。

### 海明码校验

**原理**：
通过多个校验位（海明码）构建校验方程组，覆盖不同数据位的组合。典型海明码（72,64）使用 8 位校验码保护 64 位数据：
1. 校验位分布在数据位的固定位置（如 2^n 位置：1,2,4,8,...）
2. 每个校验位对应一组数据位的异或（XOR）结果
3. 错误发生时，通过校验方程组计算结果定位错误位置

**示例**（简化的海明码 7-4 编码）：
- 数据位：D1 D2 D3 D4
- 校验位：P1=P(D1,D2,D4), P2=P(D1,D3,D4), P3=P(D2,D3,D4)

**优点**：

- 能发现并纠正 1 bit 翻转
- 能发现 2 bit 翻转

**缺点**：

- 无法处理 3 比特及以上错误
- 校验位占用空间较大（ECC 内存需增加 12.5% 容量）

### 拓展：LDPC 码

LDPC：低密度奇偶校验码（Low-Density Parity-Check Code）通过稀疏校验矩阵和迭代译码算法实现高容错能力

**原理**：

> TODO 暂不了解

**优点**：

- 可纠正多比特错误（如 5-10 bit）
- 接近香农极限的编码效率

**缺点**：

- 计算复杂度高，需专用硬件加速
- 延迟较高，通常用于企业级存储和通信系统

## 总结

- **什么是顺序 IO？什么是随机 IO？**
    答：
    - 顺序 IO：访问连续地址，利用 Burst 传输和行缓存，减少行切换开销；每次内存 IO 的行地址不变
    - 随机 IO：访问非连续地址，频繁触发行激活（tRCD）和预充电（tRP）；每次内存 IO 的行地址变化

- **Cache Line、总 Burst 数据量、Chip Burst 数据量、Burst Length、总线位宽、Chip 位宽之间的关系？**

    答：
    - Cache Line = 总 Burst 数据量，也就是一次 64 字节（512 bit），典型值。
    - 总线位宽 = Chip 位宽 x Chip 数量，64 bit，1 个 channel 典型值
    - 总 Burst 数据量 = Burst Length x Chip 位宽 x Chip 数量
      - 都取典型值：512(64 bytes) = 8 x 8 x 8(bit)

- **为什么 DDR 内存的随机访问延迟远高于顺序访问？**
    答：随机访问需频繁执行行激活（tRCD 约 16ns）和预充电（tRP 约 16ns），而顺序访问在单行内通过 Burst 传输（仅需 1 次行激活 + 连续列访问）。

- **内存的内部物理结构是什么样的？**
    答：采用分层架构：存储单元（Cell）由晶体管和电容组成 → 构成 Bank（二维矩阵） → 多个 Bank 组成 Chip（内存颗粒） → 多个 Chip 组成 Rank（64/72 bit 并行访问） → 多个 Rank 构成内存条。

- **怎么理解内存的主频？它代表内存一秒能工作的次数吗？**
    答：主频指核心频率，是物理电路的震荡频率。代表内存一秒能工作的次数。

- **内存的 CL、tRCD、tRP 这几个参数的含义是什么？**
    答：
    - CL（CAS Latency）：列地址选通延迟，决定读取首个数据的等待时间
    - tRCD（RAS to CAS Delay）：行激活到列访问的最小间隔
    - tRP（Row Precharge Time）：关闭当前行并准备新行的时间

- **内存存在随机 IO 比顺序 IO 访问要慢的情况吗？**
    答：存在。随机 IO 需要频繁切换行地址（触发 tRCD 和 tRP 延迟），而顺序 IO 可在同一行内通过 Burst 传输连续数据，减少行激活开销。

- **如何查看内存核心频率等信息？**
    答：
    ```bash
    cat /proc/meminfo
    dmidecode -t memory
    lshw -C memory
    ```

- **什么是内存 Bank Group？**
    答：DDR4/DDR5 将多个 Bank 划分为组（如 DDR4 每 Group 4 Banks），组内 Bank 可并行操作（不同 Group 的 Bank 可同时预充电或激活），提升并发性能。

- **什么是核心频率？时钟频率？数据频率？**
    答：
    - 核心频率：物理电路震荡频率（如 DDR4-3200 为 200 MHz）
    - 时钟频率：I/O 接口频率（如 1600MHz）
    - 数据频率：等效传输速率（时钟频率 × 2，如 3200 MT/s）

- **有哪些提升内存访问效率的技术？**
    答：
    - **DDR 双倍速率**：每个时钟周期在上升沿和下降沿各传输一次数据，使等效传输频率 = 核心频率 × 2 × 预取倍数。
    - **预取技术（Prefetch）**：内存一次从存储单元中读取多倍数据（如 DDR4 预取 8n），通过提高数据吞吐量降低核心频率需求。
    -  **Bank Group 并行**：不同 Bank Group 可同时操作

- **ECC 内存是什么？其原理是什么？**
    答：ECC（Error Correcting Code）内存通过海明码或 LDPC 码检测并纠正数据错误。以海明码为例：每 64 bit 数据添加 8 bit 校验码，通过异或运算定位并修复单比特错误。

- **ECC 内存的 8 个校验位的位置是固定的吗？**
    答：是固定的。校验位通常集中排列在数据块末尾（如 64 bit 数据 + 8 bit 校验），或按 2^n 位置插入（如海明码标准布局），由内存控制器硬件约定。

- **什么是 Chip？什么是 Rank？**
    答：
    - Chip：独立的内存颗粒（如 DDR4 芯片），提供 4/8/16 bit 位宽
    - Rank：由多个 Chip 组成的并行访问单元（如 8 个 8-bit Chip 组成 64-bit Rank）
    - 因此一次内存 IO，会同事访问多个 Chip。
