# 第十三章 调用原理及性能

## 问题

- C 函数调用开销计算？
- Go 函数调用开销计算？
- 如何获取/计算系统调用的开销？
- 系统调用、函数调用等开销分别是什么样的级别？

## 解答

### C 函数调用开销计算（p412）

```bash
make -C ./第13章-调用原理及性能 test1
```

可得到测试结果，大概是 8 个指令，代码详见 [test1-1.c](./Test/第13章-调用原理及性能/test1-1.c) 和 [test1-2.c](./Test/第13章-调用原理及性能/test1-2.c)

相关的 gdb 调试指令，查看函数调用对应的汇编代码：

```bash
gdb test1-1.out -ex "start" -ex "disassemble"
```

### Go 函数调用开销计算（p415）

```bash
make -C ./第13章-调用原理及性能 test2
```

可获取到 go 程序对应的汇编代码。

```bash
make -C ./第13章-调用原理及性能 test3
```

可获取到 C 函数和 Go 函数的函数调用耗时比较。Go 代码详见 [test3-1.go](./Test/第13章-调用原理及性能/test3-1.go) 和 [test3-2.go](./Test/第13章-调用原理及性能/test3-2.go)

### 如何获取/计算系统调用的开销？

方法 1：

```bash
strace -cp PID
```

一段时间后，CTRL + C 中断即可输出系统调用统计。

注意：strace 显示的是 wall-clock time（挂钟时间/实际流逝时间），而不是 CPU 时间。

方法 2：

写代码计算，详见：[test4.c](./Test/第13章-调用原理及性能/test4.c)

### 系统调用、函数调用等开销分别是什么样的级别？

系统调用：微秒到毫秒级别，不同系统调用需要进行的操作不同，时间消耗差异较大。例如个人测试机器上，read 27 微秒，clone 387 微秒，wait4 是 6490 微秒（wait4 是等待子进程执行完退出，不会占用 CPU）。
函数调用：纳秒级别。例如个人机器上，C 函数的简单函数调用是 0.11 ns，go 函数调用是 1.24 ns。（通过上面的测试程序可获取）
