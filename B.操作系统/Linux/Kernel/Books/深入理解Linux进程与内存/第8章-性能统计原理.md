# 性能统计原理

## 问题

- CPU 关键的性能指标有哪些？
- top 命令中的平均负载（过去 1/5/15 分钟平均负载）是怎么得到的？
- 负载是如何计算出来的？
- 负载高低和 CPU 消耗正相关吗？
- 内核是如何给应用层暴露负载数据的？
- top 输出的利用率信息是如何计算出来的，它精确吗？
- top 输出中 ni 列代表的是 nice，它输出的是 CPU 在处理什么时的开销？
- top 输出中 wa 列代表的是 iowait，那么这段时间 CPU 到底是忙碌还是空闲？
- 在性能观测中为什么 CPI 指标非常重要？

## 总结

### CPU 关键的性能指标有哪些？

1. 负载
2. CPU 利用率
3. CPI（cycle per instruction）：平均每条指令的时钟周期数。

### top 命令中的平均负载（过去 1/5/15 分钟平均负载）是怎么得到的？

从 /proc/loadavg（对应内核源码文件 fs/proc/loadavg.c）获取。

### 负载是如何计算出来的？

Linux 定时将每个 CPU 上的运行队列中的 running 和 uninterruptible 状态的进程的数量汇总到一个全局系统瞬时负载值中，然后再定时（do_timer 函数？!）使用“指数加权移动平均法（Exponential Weighted Moving Average, EMWA）”来统计过去 1 分钟、过去 5 分钟和过去 15 分钟的平均负载。

详见 Linux 内核源码：calc_global_load。

### 负载高低和 CPU 消耗正相关吗？
### 内核是如何给应用层暴露负载数据的？
### top 输出的利用率信息是如何计算出来的，它精确吗？
### top 输出中 ni 列代表的是 nice，它输出的是 CPU 在处理什么时的开销？
### top 输出中 wa 列代表的是 iowait，那么这段时间 CPU 到底是忙碌还是空闲？
### 在性能观测中为什么 CPI 指标非常重要？
