# 第六章 CPU

## 6.1 背景知识

### 6.1.1 CPU基础知识

CPU 的运行模式：CPU 和其他硬件资源都是由系统内核(Kernel)管理的，系统内核运行于一个特殊的模式下一系统模式(System mode)。用户态应用程序运行于用户模式(User mode)

调度器：调度不同的程序使之共享CPU资源。

调度单元：进程、线程、中断处理程序。

CPU 缓存：L1 和 L2 缓存通常是每个CPU核独占的。

### 6.1.2 BPF 的分析能力

测量 CPU 用量的各种事件源：

![](https://user-images.githubusercontent.com/13636347/160239769-e52501ce-c9fc-41d5-8392-88bc9e6b256c.png)

### 6.1.3 分析策略

- 在花时间使用分析工具之前，先保证待分析的对象处于CPU运行状态。检查系统中的整体CPU利用率（例如，用mpstat(1)),并且保证每个CPU都处于在线状态（检查是否有些CPU由于某些原因处于下线状态）。
- 确认系统负载确实受限于CPU。
  - 系统中所有CPU的使用率是否都很高，还是仅某个CPU使用率高（例如，用mpstat(1))。
  - 检查系统中运行队列的延迟（例如，使用BCC runglat(I)。系统中的一些软件限制—例如容器的设置一可以限制进程所能使用的CPU资源，进而导致某些程序在空闲系统上仍然受限于CPU。通过分析运行队列延迟，可以识别这种类型的反常规情景。
- 先量化整个系统中的CPU使用量的百分比，然后再按进程、CPU模式、CPUID来分解。这可以用传统工具来进行（如mpstat(1)、top(1)等）。可以通过某种模式或者某个CPU的高使用率情况寻找某个进程。
  - 如果系统时间占比高，那么可按照进程和系统调用类型来统计系统调用的频率和数量，同时检查系统调用的参数来识别值得优化的地方（例如，使用perf(I)、bpftrace单行程序，以及BCC sysstat(8)。
- 用性能剖析器(Profiler)来采样应用程序的调用栈信息，再用CPU火焰图来展示。很多CPU问题都可以通过检查火焰图来分析。
- 针对某个CPU使用率高的任务，可考虑开发一些定制工具来获取更多的上下文信息。性能剖析器通常可以展示哪些函数正在运行，但是不能展示调用参数和函数内部的信息，理解CPU用量时可能需要这些信息。例如，
  - 内核模式：如果某个文件系统针对文件进行stat0消耗了很多CPU资源，那么文件名是什么？（这可以用BCC statsnoop(8)来获取，也可以通过BPF工具的内核跟踪点和kprobes来获取。)
  - 用户模式：如果某个应用程序忙于处理请求，那么这些请求到底是什么？（如果没有针对这个程序的特定工具，可以考虑用USDT或uprobes来开发这种工具。)
- 测量硬中断的资源消耗，这些信息可能对基于定时器的分析器不可见（例如BCC hardirgs(I))。
- 从本章中提到的BP℉工具中选择一个执行。
- 利用PMC来测量每时钟周期内的CPU指令执行量(IPC),以理解宏观层面CPU的阻塞情况。还有其他的PMC可以进一步帮助分析低缓存命中率（如BCC llcstat)、温控导致的阻塞等问题。


## 6.2 传统工具

### 6.2.4 定时采样
* 用 perf 指令以 49Hz 的频率采样 30 秒，并产生 CPU 火焰图：

```
git clone https://github.com/brendangregg/FlameGraph
cd FlameGrash
perf record -F 49 -ag -- sleep 30
perf script --header | ./stackcollapse-perf.pl | ./flamegraph.pl > flame1.svg
```
