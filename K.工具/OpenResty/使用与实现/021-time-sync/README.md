# OpenResty 时间更新机制

目的：

- 了解 OpenResty/Nginx 中时间是如何更新？
- 各个进程各自更新？还是一个进程更新，其他进程使用？
- 示例：获取到的 cache 的时间可能比当前时间更新（差 1、2 秒）是什么原因导致？似乎都用的是 ngx_time（一个 C、一个 Lua）

## 参考

- gpt

```
1. 事件驱动模型：
NGINX使用事件驱动模型来处理网络请求和响应。它依赖于操作系统提供的事件通知机制（如epoll、kqueue、select等）来检测和处理网络事件。当有新的连接、数据可读或可写等事件发生时，NGINX会相应地调度事件处理。

2. 定时器管理：
定时器用于处理需要在特定时间触发的事件，如超时处理或定期任务。NGINX使用定时器来管理这些事件，并在适当的时间触发相应的操作。定时器的管理包括以下几个关键步骤：

  - 创建定时器：当需要设置一个定时器时，NGINX会创建一个相应的定时器对象，并将其添加到定时器列表中。
  - 定时器排序：定时器列表按照触发时间进行排序，确保最近的定时器在列表的前面。
  - 定时器触发：当定时器到达其触发时间时，NGINX会执行相应的操作，如超时处理或定期任务的执行。
  - 定时器更新：在事件循环过程中，NGINX会检查定时器列表，将已经到达或超过触发时间的定时器从列表中移除，并执行相应的操作。
  - 定时器精度：NGINX的定时器精度受到系统的时钟分辨率和timer_resolution配置参数的影响。

3. 时间更新机制：
NGINX的时间更新机制涉及到定期更新系统时间和定时器的管理。具体步骤如下：

  - 初始化时间：在NGINX启动时，会初始化一个基准时间，通常是系统启动的时间。
  - 更新时间：在事件循环过程中，NGINX会定期更新当前时间。这通常通过获取系统的时钟时间（如调用gettimeofday或clock_gettime函数）来实现。
  - 时间偏移：NGINX会计算当前时间与基准时间的差值，得到一个时间偏移量。这个时间偏移量用于管理定时器的触发时间，以及计算超时时间等。
  - 定时器管理：NGINX根据时间偏移量来管理定时器的触发时间。当时间偏移量发生变化时，NGINX会更新定时器列表中的定时器触发时间，确保它们与当前时间保持一致。
```
