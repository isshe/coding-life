深入理解 Nginx 模块开发与架构解析
---

看书过程中记录一些感觉重要的内容，比较零碎。

# 第 8 章 Nginx 基础架构
## 8.2 事件驱动架构

传统 WEB 服务器（进线程驱动）与 Nginx（事件驱动）间的重要区别：
- 前者的每个事件消费者独占进程/线程资源
- 后者的事件消费者只是被事件分发者进程短期调用。

事件驱动模型的优点
- 提升网络性能、吞吐量
- 降低请求延时（用户体验更好）

同时也会带来一个重要弊端：
- 每个事件消费者不能有阻塞行为，否则将会由于长时间占用事件分发者进程而导致其他事件得不到及时的响应。这加大了事件消费者程序的开发难度。

一定程度上解决这个问题：
- 拆分请求成多个阶段，异步处理。

那么划分阶段的原则是什么呢？
- 找到处理流程中的阻塞方法或造成阻塞的代码段，按以下 4 种方式进行划分：
    - 将阻塞进程的方法按照**相关的触发事件**分解为 2 个阶段：
        - 第一阶段，改用非阻塞方法进行调用，然后与事件触发关联起来；
        - 第二阶段处理前一个阶段返回的结果。
    - 将阻塞方法调用按照**时间**分解为多个阶段的方法调用：
        - 注：系统的事件收集/分发者，并不不是可以处理任意事件。也就是前一个方法不能用了。
        - 例：读取 10 MB 文件，分成读 1000 次，每次 10 KB，每次读完，交出控制权来处理其他请求。
    - 在“无所事事”且必须等待系统的响应，从而导致进程空转时，使用**定时器**划分阶段。
        - 例：循环检测标记，满足条件才继续执行，改为使用定时器定期检查，不满足则立即交出控制权。
    - 如果阻塞方法完全无法划分阶段，则必须使用单独的进程来执行这个方法，执行完成后再通过事件通知继续后续执行。
        - 这种情况与事件驱动架构相违背，使用时需审视是否合理，有没有必要用这种方法来解决阻塞问题。
