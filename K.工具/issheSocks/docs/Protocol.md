[TOC]

协议设计
---
协议优先级：
* 无特征性：主要考虑不被识别。
* 安全性：在`无特征性`基础上，尽量保证安全性。
* 效率/性能：尽量尽量。
* 易用性：一键搭建，少量信息输入 (>=5)。
* 兼容性：主要支持`*nix系列`，跨平台、跨处理器架构等后面再考虑。

# TODO
* 学习 TLS1.3，当前先实现最简单一版
* 下一版本考虑加密模式用 gcm 的话，怎么定义头部。

# 特别说明
> `重放攻击`在选项中添加计数器/时间戳字段来解决。
> 

# 结构
* 请求/应答
```
+------------+----------+----------+
| 消息验证码 | 变长选项 | 加密数据 |
+------------+----------+----------+
|---16/32B---|---xxB----|---yyB----|
```

# 消息验证码-HMAC
> 应该就是 aes-gcm 模式的 tag

用于快速校验合法用户。

# 变长选项
使用`aes-cfb-128`算法加密。长度会被填充为`128bit`的整数倍。
> 所有头部选项都以如下形式进行组织，总长度可变。

```
+------+--------+------+
| TYPE | LENGTH | DATA | ...
+------+--------+------+
|--1B--|---1B---|--xB--|
```
* type: 头部类型
* length：头部数据长度
* data: 头部数据

## TYPE 列表
|名称 | 长度 | 备注|
|---|---|---|
|计数器|8B|避免重放攻击，选一种 (流式)|
|时间戳|8B|避免重放攻击，选一种 (非流式)|
|随机码|4B|选项靠前|
|会话向量|16B||
|会话秘钥|16B||
|应答验证码||考虑要不要|
|数据长度|2B||

# 加密数据
* 全部都是数据，不含其他东西。


# 核心字段
> 用户输入：`ip、port、username、userpwd`
> `userpwd`相当于 v2ray 的 id。

* HMAC: 消息验证码。
  * 长度：16/32B(128/256b)
  * 生成方式：
    * 请求：HMAC(md5, userpwd, 加密选项前 16 字节)
    * 应答：HMAC(md5, userpwd, 加密选项前 16 字节)
* master key：主密码。
  * 长度：16B
  * 生成方式：xor(md5(userpwd), md5(HMAC))
* master iv：主向量。
  * 长度：16B
  * 生成方式：xor(md5(username), md5(HMAC)) 
* session key：会话密码，客户端生成后通过头部选项传递过来。
  * 长度：16B
  * 生成方式：伪随机数。
* session iv：同 session key。
* session reply key: 服务器应答使用的 key。

gcm:
* key: key
* iv: iv
* tag: hmac
* aad: 
